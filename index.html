<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SafeTalk Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Background animation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta/dist/vanta.waves.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<div class="g_id_signin" data-type="standard"></div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  html, body { height:100%; margin:0; font-family:'Montserrat', sans-serif; overflow:hidden; }
  #vanta-bg { position:fixed; width:100vw; height:100vh; z-index:-1; }

  /* Glass Panels */
  .glass {
    background: rgba(255,255,255,0.93);
    border-radius: 20px;
    padding: 1.5rem;
    max-width: 420px;
    margin: 2rem auto;
    box-shadow: 0 8px 30px rgba(94,96,206,0.18);
    border: 1px solid rgba(255,255,255,0.4);
    animation: fadein 1.2s ease;
  }


  @keyframes fadein { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

  #chat-panel { display:none; height:80vh; }
  #chat-messages {
    height:60vh; overflow-y:auto; background:#f6faff;
    border-radius:16px; padding:1rem; margin-bottom:1rem;
    scroll-behavior:smooth;
  }

  /* Message Bubbles */
  .message-container { display:flex; align-items:flex-end; margin:10px 0; opacity:0; transform:translateY(15px); animation: slideUp 0.4s forwards; }
  @keyframes slideUp { to{opacity:1; transform:translateY(0);} }

  .message-container.my { justify-content:flex-end; }
  .bubble {
    padding:10px 14px; border-radius:16px; max-width:70%; font-size:1rem;
    box-shadow:0 2px 6px rgba(0,0,0,0.1); transition:background 0.3s;
  }
  .bubble.my { background:#dbeafe; color:#023e8a; text-align:right; border-radius:16px 16px 0 16px; }
  .bubble.other { text-align:left; border-radius:16px 16px 16px 0; }

  .avatar { width:34px; height:34px; border-radius:50%; margin:0 8px; box-shadow:0 0 4px rgba(0,0,0,0.15); }
  .sender-name { font-size:.8em; font-weight:600; margin-bottom:3px; }
  .timestamp { display:block; font-size:.72em; color:#666; margin-top:5px; }

  /* Active users scaling */
  #users-list { color:#5e60ce; margin-bottom:8px; transition:font-size 0.3s ease; }

  /* Google sign in hover */
  .g_id_signin:hover { filter: drop-shadow(0 0 6px rgba(94,96,206,0.6)); }
</style>
</head>
<body>
  <div id="vanta-bg"></div>

<!-- Login -->
<div id="login-panel" class="glass" style="padding-top:2.5rem; padding-bottom:2.5rem;">
  <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExN3Ftd2xrdHo0eTY4YTk0NXpndDlid21kcDFieGpleXYzdDN1M2IwZSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/K27SLAxTENwvQqOgPB/giphy.gif"
     alt="Welcome GIF" style="width:250px;height:250px;display:block;margin:0 auto 25px auto;
     border-radius:20px;box-shadow:0 6px 16px rgba(0,0,0,0.25);">


  <h2 style="text-align:center;color:#5e60ce;font-size:2em;margin-bottom:10px;">
    Welcome to SafeTalk ðŸŽ‰
  </h2>
  <p style="text-align:center;color:#444;margin-bottom:25px;font-size:1.1em;">
    ðŸš€ Secure Chat with Google Sign-In
  </p>

<div id="g_id_onload"
     data-client_id="YOUR_GOOGLE_CLIENT_ID_HERE"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false"></div>
<div class="g_id_signin" data-type="standard"></div>
  <div class="g_id_signin" data-type="standard" style="display:block;margin:0 auto;"></div>
  
  <div id="login-error" style="color:red;text-align:center;margin-top:15px;"></div>
</div>

  <!-- Chat -->
  <div id="chat-panel" class="glass">
    <div id="users-list"></div>
    <div id="chat-messages"></div>
    <input id="chat-input" type="text" placeholder="Type your message..." maxlength="200" style="width:72%;padding:8px;border-radius:12px;border:1px solid #ccc;" />
    <button id="send-btn" style="padding:8px 14px;border:none;border-radius:12px;background:linear-gradient(90deg,#5e60ce,#48bfe3);color:white;cursor:pointer;">Send</button>
    <div id="warn" style="color:#e63946; margin-top:6px;"></div>
  </div>

<script>
VANTA.WAVES({
  el: "#vanta-bg", mouseControls:true, touchControls:true,
  color: 0x5e60ce, waveHeight:20, shininess:40, waveSpeed:1.2
});

let ws, myEmail="", myName="", myPic="", authToken="";
const loginPanel=document.getElementById("login-panel"), chatPanel=document.getElementById("chat-panel");
const chatMessages=document.getElementById("chat-messages"), usersList=document.getElementById("users-list");
const warn=document.getElementById("warn"), input=document.getElementById("chat-input"), sendBtn=document.getElementById("send-btn");

function handleCredentialResponse(response){ authToken=response.credential; connectWS(); }

function connectWS(){
  ws=new WebSocket("ws://127.0.0.1:12345");
  ws.onopen=()=>ws.send(JSON.stringify({type:"auth",token:authToken}));
  ws.onmessage=(ev)=>{
    const data=JSON.parse(ev.data);
    if(data.type==="kick"){ document.getElementById("login-error").textContent=data.content; ws.close(); }
    else if(data.type==="system"){ showChat(); addSystem(data.content); }
    else if(data.type==="user_list"){ showUsers(data.users); }
    else if(data.type==="chat"){ addMessage(data.content,data.sender,data.name,data.pic,data.timestamp); if(data.sender===myEmail&&!myName){ myName=data.name; myPic=data.pic; } }
    else if(data.type==="warning"){ warn.textContent=data.content; setTimeout(()=>warn.textContent="",4000); }
  };
}

sendBtn.onclick=sendMsg;
input.addEventListener("keyup",e=>{if(e.key==="Enter")sendMsg();});
function sendMsg(){ const msg=input.value.trim(); if(msg&&ws.readyState===1){ ws.send(JSON.stringify({type:"chat",content:msg})); input.value=""; } }

function addSystem(text){ let div=document.createElement("div"); div.className="system-message"; div.textContent=text; div.style.textAlign="center"; div.style.fontStyle="italic"; div.style.color="#5e60ce"; chatMessages.appendChild(div); chatMessages.scrollTop=chatMessages.scrollHeight; }

const userColors={}, pastel=["#f8cdda","#fbc4ab","#ffb5a7","#b5ead7","#c7ceea","#f9e79f","#a5d8ff","#ffd6a5","#d0f4de"];
function getUserColor(email){ if(!userColors[email]){ let i=Object.keys(userColors).length%pastel.length; userColors[email]=pastel[i]; } return userColors[email]; }

function addMessage(msg,senderEmail,name,pic,ts){
  const itsMe=(myEmail&&senderEmail===myEmail);
  const cont=document.createElement("div"); cont.className="message-container "+(itsMe?"my":"");
  const bubble=document.createElement("div"); bubble.className="bubble "+(itsMe?"my":"other");
  if(!itsMe) bubble.style.background=getUserColor(senderEmail);
  bubble.innerHTML=`<div class="sender-name">${name||senderEmail}</div>${escapeHTML(msg)}<span class="timestamp">${formatTime(ts)}</span>`;
  const avatar=document.createElement("img"); avatar.className="avatar"; avatar.src=pic||"https://ui-avatars.com/api/?name="+encodeURIComponent(name||"User");
  if(itsMe){ cont.appendChild(bubble); cont.appendChild(avatar);} else{ cont.appendChild(avatar); cont.appendChild(bubble);}
  chatMessages.appendChild(cont); chatMessages.scrollTop=chatMessages.scrollHeight;
  if(!myEmail&&itsMe) myEmail=senderEmail;
}

function showUsers(users){
  if(!users||!users.length){ usersList.textContent=""; return; }
  usersList.innerHTML="<b>Active:</b> "+users.map(u=>u.name||u.email).join(", ");
  let size=Math.max(0.6,1.0-(users.length-3)*0.05); usersList.style.fontSize=size+"em";
}

function showChat(){ loginPanel.style.display="none"; chatPanel.style.display="block"; }
function formatTime(s){ if(!s) return""; let d=new Date(s); return d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}); }
function escapeHTML(str){ return str.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }
</script>
</body>
</html>
